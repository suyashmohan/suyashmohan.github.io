<!DOCTYPE html><html><head><meta charset="utf-8"><title>Setup Databases like PostgreSQL inside Kubernetes cluster | Farzi Coder</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Kubernetes is getting a lot of traction in the world of DevOps for hosting stateless microservices. But what about Stateful applications like Databases? It’s been a topic of debate when it comes to ho"><meta name="keywords" content="Kubernetes,Containers,Postgresql,Database"><meta property="og:type" content="article"><meta property="og:title" content="Setup Databases like PostgreSQL inside Kubernetes cluster"><meta property="og:url" content="http://farzicoder.com/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/index.html"><meta property="og:site_name" content="Farzi Coder"><meta property="og:description" content="Kubernetes is getting a lot of traction in the world of DevOps for hosting stateless microservices. But what about Stateful applications like Databases? It’s been a topic of debate when it comes to ho"><meta property="og:locale" content="default"><meta property="og:updated_time" content="2020-01-27T02:38:26.896Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Setup Databases like PostgreSQL inside Kubernetes cluster"><meta name="twitter:description" content="Kubernetes is getting a lot of traction in the world of DevOps for hosting stateless microservices. But what about Stateful applications like Databases? It’s been a topic of debate when it comes to ho"><link rel="alternate" href="/atom.xml" title="Farzi Coder" type="application/atom+xml"><link rel="icon" href="/favicon.png"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-100366340-1', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics --></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">Farzi Coder</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">Adventures of a coder</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://farzicoder.com"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/" class="article-date"><time datetime="2020-01-27T05:00:00.000Z" itemprop="datePublished">2020-01-27</time></a><div class="article-category"><a class="article-category-link" href="/categories/Kubernetes/">Kubernetes</a></div></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Setup Databases like PostgreSQL inside Kubernetes cluster</h1></header><div class="article-entry" itemprop="articleBody"><p>Kubernetes is getting a lot of traction in the world of DevOps for hosting stateless microservices. But what about Stateful applications like Databases? It’s been a topic of debate when it comes to hosting databases on Kubernetes or even docker for production environments. Thankfully Kubernetes does have a special resource that can be used for setting applications like Databases. I am talking about Statefulsets.</p><p>StatefulSets are like deployment resources but they are special in the sense that Kubernetes maintains a persistent identifier for the pods and hence these pods are not interchangeable. This helps when running stateful applications.</p><p>To learn more about this, we will set up a Postgres database inside Kubernetes. Although we are using Postgres the concepts and steps are the same for any databases like MySQL, etc.</p><a id="more"></a><p>In order to set up this configuration, we will need to set up the following resources:</p><ol><li>Storage Class</li><li>Persistent Volume</li><li>Persistent Volume Claim</li><li>Stateful Set</li><li>Config Map</li><li>Service</li></ol><p>Since the data is persistent we don’t want to save our data inside the container’s storage. Instead, we want to mount external storage inside the Pod. In this way even if Pod dies, our data stays safe. Kubernetes has the concept of Persistent Volume and Persistent Volume Claim. To explain in simple terms, we need to claim a volume so that it belongs to us and we don’t end having two pods writing to the same storage. PersistentVolume defines these external storage volumes. Then PersistentVolumeClaims is a way to claim these storage volumes. A Persistent volume also needs to define what kind of Storage Class it needs. In Kubernetes, these storage volumes could be anything. It could be EBS in AWS or a local folder or any other block storage in other cloud providers. Hence we define a Storage Class with specific provisioner.</p><p>For this setup, I used microk8s. You can install it on Ubuntu by simply using snap</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo snap install microk8s --classic --edge</div></pre></td></tr></table></figure><p>Let’s define a Storage Class that uses the provisioner provided by microk8s. It is essentially local storage already set up inside micro8ks.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kind: StorageClass</div><div class="line">apiVersion: storage.k8s.io/v1</div><div class="line">metadata:</div><div class="line">  name: microk8s-hostpath</div><div class="line">  annotations:</div><div class="line">    storageclass.kubernetes.io/is-default-class: &quot;true&quot;</div><div class="line">provisioner: microk8s.io/hostpath</div></pre></td></tr></table></figure><p>Now we need to define PersistentVolume that will use this Storage Class and following it we also define PersistenVolumeClaim to claim this volume</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">kind: PersistentVolume</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: postgres-pv</div><div class="line">  labels:</div><div class="line">    app: postgres</div><div class="line">    type: local</div><div class="line">spec:</div><div class="line">  storageClassName: microk8s-hostpath</div><div class="line">  capacity:</div><div class="line">    storage: 5Gi</div><div class="line">  accessModes:</div><div class="line">    - ReadWriteOnce</div><div class="line">  hostPath:</div><div class="line">    path: &quot;/var/data&quot;</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">kind: PersistentVolumeClaim</div><div class="line">apiVersion: v1</div><div class="line">metadata:</div><div class="line">  name: postgres-pv-claim</div><div class="line">  labels:</div><div class="line">    app: postgres</div><div class="line">spec:</div><div class="line">  storageClassName: microk8s-hostpath</div><div class="line">  capacity:</div><div class="line">  accessModes:</div><div class="line">    - ReadWriteOnce</div><div class="line">  resources:</div><div class="line">    requests:</div><div class="line">      storage: 5Gi</div></pre></td></tr></table></figure><p>Since we are using a local disk provisioner we need to define where on host node our data will be saved. Here we choose <code>/var/data/</code>. Another important parameter is <code>accessMode</code>. Here we choose <code>ReadWriteOnce</code>. This will make sure only one pod can write at a time. So, no two pods end up with this volume for writing. We can also define what should be the size of this volume, which we choose 5Gb.</p><p>Next, we will setup ConfigMap. They are just an easy way to provide configuration for our setup. The advantage is we can get the values like username and password by different means for example Environment Variables making sure we don’t end up saving passwords in our code. To keep this example simple we have hardcoded the values inside ConfigMap.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: postgres-configuration</div><div class="line">  labels:</div><div class="line">    app: postgres</div><div class="line">data:</div><div class="line">  POSTGRES_DB: awesomedb</div><div class="line">  POSTGRES_USER: amazinguser</div><div class="line">  POSTGRES_PASSWORD: perfectpassword</div></pre></td></tr></table></figure><p>Now we have our Configs and Storage Volume, we can define our StatefulSet that will use these,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: StatefulSet</div><div class="line">metadata:</div><div class="line">  name: postgres-statefulset</div><div class="line">  labels:</div><div class="line">    app: postgres</div><div class="line">spec:</div><div class="line">  serviceName: &quot;postgres&quot;</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: postgres</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: postgres</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: postgres</div><div class="line">        image: postgres:12</div><div class="line">        envFrom:</div><div class="line">        - configMapRef:</div><div class="line">            name: postgres-configuration</div><div class="line">        ports:</div><div class="line">        - containerPort: 5432</div><div class="line">          name: postgresdb</div><div class="line">        volumeMounts:</div><div class="line">        - name: pv-data</div><div class="line">          mountPath: /var/lib/postgresql/data</div><div class="line">      volumes:</div><div class="line">      - name: pv-data</div><div class="line">        persistentVolumeClaim:</div><div class="line">          claimName: postgres-pv-claim</div></pre></td></tr></table></figure><p>The definition for Stateful Set is pretty much the same as Deployments. Here we have added two additional things. One we defined to load environment variables inside pod from the config map we defined earlier. Second the most important change, we defined our volume that will map to /var/lib/PostgreSQL/data inside our pod. This volume is defined using the persistent volume claim we used earlier.</p><p>Lastly, we can define a service resource to expose our database.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: postgres-service</div><div class="line">  labels:</div><div class="line">    app: postgres</div><div class="line">spec:</div><div class="line">  ports:</div><div class="line">  - port: 5432</div><div class="line">    name: postgres</div><div class="line">  type: NodePort </div><div class="line">  selector:</div><div class="line">    app: postgres</div></pre></td></tr></table></figure><p>To test these files, simply apply the files. Best to apply ConfigMap and Storage YAMLs first.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo microk8s.kubectl apply -f file.yml</div></pre></td></tr></table></figure><p>You can check if everything is okay by using<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ sudo microk8s.kubectl get storageclass</div><div class="line">$ sudo microk8s.kubectl get persistentvolume</div><div class="line">$ sudo microk8s.kubectl get persistentvolumeclaim</div><div class="line">$ sudo microk8s.kubectl get configmap</div><div class="line">$ sudo microk8s.kubectl get statefulset</div><div class="line">$ sudo microk8s.kubectl get service</div></pre></td></tr></table></figure></p><p>If persistent volume claim gets stuck waiting, the stateful set will also get stuck as it can’t get its storage. So make sure both StorageClass and PersistentVolume are created properly.</p><p>If you are using Minikube, you might want to change the provisioner in StorageClass. Similarly, you can change it to EBS, etc for production setup.</p><p>This was an essential setup of all resources needed to host something like PostgreSQL databases. The same steps can be followed and used with MySQL, MongoDB or any other stateful application. If you have any doubts or thought do share it through the comments.</p></div><footer class="article-footer"><a data-url="http://farzicoder.com/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/" data-id="ck5vuei2z000l7vmntszq65uc" class="article-share-link">Share</a> <a href="http://farzicoder.com/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/#disqus_thread" class="article-comment-link">Comments</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Containers/">Containers</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database/">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Postgresql/">Postgresql</a></li></ul></footer></div><nav id="article-nav"><a href="/Nginx-Ingress-setup-for-kubernetes/" id="article-nav-older" class="article-nav-link-wrap"><strong class="article-nav-caption">Older</strong><div class="article-nav-title">Nginx Ingress setup for kubernetes</div></a></nav></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">Categories</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Blockchain/">Blockchain</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Thoughts/">Thoughts</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tags</h3><div class="widget"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blockchain/">Blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Containers/">Containers</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ethereum/">Ethereum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express-js/">Express.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NPM/">NPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Postgresql/">Postgresql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Smart-Contracts/">Smart Contracts</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thoughts/">Thoughts</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Tag Cloud</h3><div class="widget tagcloud"><a href="/tags/Blockchain/" style="font-size: 16.67px">Blockchain</a> <a href="/tags/Containers/" style="font-size: 13.33px">Containers</a> <a href="/tags/Database/" style="font-size: 10px">Database</a> <a href="/tags/Ethereum/" style="font-size: 16.67px">Ethereum</a> <a href="/tags/Express-js/" style="font-size: 10px">Express.js</a> <a href="/tags/Javascript/" style="font-size: 20px">Javascript</a> <a href="/tags/Kubernetes/" style="font-size: 13.33px">Kubernetes</a> <a href="/tags/NPM/" style="font-size: 10px">NPM</a> <a href="/tags/Node-js/" style="font-size: 20px">Node.js</a> <a href="/tags/Postgresql/" style="font-size: 10px">Postgresql</a> <a href="/tags/Smart-Contracts/" style="font-size: 16.67px">Smart Contracts</a> <a href="/tags/Thoughts/" style="font-size: 10px">Thoughts</a></div></div><div class="widget-wrap"><h3 class="widget-title">Archives</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">Recent Posts</h3><div class="widget"><ul><li><a href="/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/">Setup Databases like PostgreSQL inside Kubernetes cluster</a></li><li><a href="/Nginx-Ingress-setup-for-kubernetes/">Nginx Ingress setup for kubernetes</a></li><li><a href="/Writing-your-First-Smart-Contract-using-Solidity-Part-2-Getting-Started-with-Smart-Contracts-Blockchain/">Writing your first Smart Contract using Solidity - Part 2 - Getting Started with Smart Contracts &amp; Blockchain</a></li><li><a href="/Setting-up-Geth-Mist-TestRPC-Part-1-Getting-Start-with-Smart-Contracts/">Setting up Geth, Mist &amp; TestRPC - Part 1 - Getting Started with Smart Contracts &amp; Blockchain</a></li><li><a href="/Getting-Started-with-Smart-Contracts-Blockchain-Part-0-Understanding-Basics/">Getting Started with Smart Contracts &amp; Blockchain - Part 0 Understanding Basics</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner">&copy; 2020 Suyash Mohan<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script>var disqus_shortname = 'farzi-coder';
  
  var disqus_url = 'http://farzicoder.com/Setup-Databases-like-PostgreSQL-inside-Kubernetes-cluster/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();</script><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/js/script.js"></script></div></body>